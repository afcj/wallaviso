{% extends 'layouts/master.html' %}
{% block page %}searchs{% endblock %}
{% block title %}Busquedas | {% endblock %}
{% block body %}
<div class="container" id="appSearchs">
	<form method="post" id="form_add">
		<input type="hidden" name="add" value="{{ form.name.data }}">
                <input type="hidden" name="lat" value="[[ lat ]]">
                <input type="hidden" name="lng" value="[[ lng ]]">
		<input type="hidden" name="distance" value="">
		<input type="hidden" name="max_price" value="">
	</form>
	<div class="row">
		<div class="col-xs-12">
			<h1>Avisos programados</h1>
		</div>
	</div>
	<div class="row">
		<div class="col-sm-4" v-if="results" id="separation">
			<h2>Buscar</h2>
			<form method="post" class="form" id="form_search">
                                <div class="form-group">
                                    <label for="name">Nombre</label>
                                    <input v-model="name" class="form-control" type="text">
                                </div>
                                <div class="form-group">
                                    <label for="postal_code">Código postal</label>
                                    <input v-model="postal_code" @keyup="searchPostalCode" id="postal_code" class="form-control" type="number">
                                </div>
                                <div v-if="listLocations.length > 0" class="form-group">
                                    <label for="location">Ciudad o pueblo</label>
                                    <select @change="setLocation" id="location" class="form-control">
                                        <option v-for="item in listLocations" :value="item.index">[[ item.poblacion ]]</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="distance">Distancia</label>
                                    <select v-model="distance" id="distance" class="form-control">
                                        <option v-for="item in listDistance" :value="item.key">[[ item.value ]]</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="max_price">Precio máximo</label>
                                    <input v-model="max_price" id="max_price" class="form-control" type="number">
                                </div>
                                <div class="form-group">
                                    <label for="min_price">Precio mínimo</label>
                                    <input v-model="min_price" id="min_price" class="form-control" type="number">
                                </div>

                                <button id="search_button" type="submit" name="search" class="btn btn-success w-100">
                                        <i class="fa fa-search" aria-hidden="true"></i>
                                </button>
			</form>
			<h2 id="number_wallavisos">
				<span class="color_wallaviso">Wallavisos</span> activos <span class="badge">{{ searchs_len }}</span>
			</h2>
			<ul class="list-group">
				{% if searchs %}
					<form method="post">
					{% for item in searchs %}
					<li class="list-group-item">
						<div class="row">
							<div class="col-xs-10">
								<h4>{{ item.name }}</h4>
								<p>
									<strong>Distancia:</strong> 
									{% if item.distance == '0_1000' %}
										Muy cerca
									{% elif item.distance == '0_5000' %}
										En mi zona
									{% elif item.distance == '0_10000' %}
										En mi ciudad
									{% else %}
										Sin límite
									{% endif %}
								</p>
								<p>
									<strong>Precio máximo:</strong> 
									{% if item.max_price == 0.0 %}
										Ninguno
									{% else %}
										{{ "{:.2f}".format(item.max_price) | replace('.00','') | replace('.',',') }} &euro;
									{% endif %}
								</p>
							</div>
							<div class="col-xs-2">
								<button type="submit" name="delete" class="btn btn-danger pull-right" value="{{ item.id }}">
									<i class="fa fa-times" aria-hidden="true"></i>
								</button>
							</div>
						</div>
					</li>
					{% endfor %}
					</form>
				{% endif %}
			</ul>
			<div id="count_notifys">
				<h2>
					Avisos diarios permitidos
				</h2>
                <h3>Cuenta: {% if session['user']['rol_id'] == 1 %}gratuita{% else %}Premium{% endif %}</h3>
				{% if num_notifys < session['user']['limit_notifys'] %}
				<div class="progress">
					<div class="progress-bar" role="progressbar" aria-valuenow="{{ session['user']['limit_notifys'] - num_notifys }}" aria-valuemin="0" aria-valuemax="{{ session['user']['limit_notifys'] }}" style="width: {{ 100 * session['user']['limit_notifys'] / (session['user']['limit_notifys'] - num_notifys) }}%;">
					  {{ session['user']['limit_notifys'] - num_notifys }}/{{ session['user']['limit_notifys'] }}
				  </div>
				</div>
				{% else %}
				<div class="progress">
				  <div class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
					<span>No te quedan, espere a mañana.</span>
				  </div>
				</div>
				{% endif %}
                {% if session['user']['rol_id'] == 1 %}
				<a href="https://programadorwebvalencia.com/#contact" class="premium">
					<p>
						<i class="fa fa-trophy" aria-hidden="true"></i>
						¿Necesitas más avisos diarios y más filtros?
					</p>
					<p class="premium__price">
						5&euro;/mes
					</p>
				</a>
				{% endif %}
                                <div id="map"></div>
			</div>
		</div>
		<main class="col-sm-8">
		{% if request.method == 'POST' %}
			{% if results %}
			<section v-if="results" class="row">
				<div class="col-xs-12">
					<h3>Crea nuevo <span class="color_wallaviso">Wallaviso</span></h3>
					{% for item in results[:LIMIT_RESULTS] %}
						<div class="row">
							<div class="col-xs-12">
								<h4><strong>{{ item.title }}</strong></h4>
							</div>
							<div class="col-sm-4">
								<img class="img-responsive" src="{{ item.mainImage.smallURL }}" alt="Imagen">
							</div>
							<div class="col-sm-5">
								<p>
									{{ item.description }}
								</p>
							</div>
							<div class="col-sm-2 text-center price">
								{{ item.price }}
							</div>
							<div class="col-sm-1">
								<button class="btn btn-success next pull-right"  v-on:click="next('{{ item.title }}')">
									<i class="fa fa-arrow-right" aria-hidden="true"></i>
								</button>
							</div>

						</div>
						<hr>
					{% endfor %}
				</div>
			</section>
			{% endif %}
			<section {% if results %}v-if="confirm_add"{% endif %} id="confirm">
				<div class="row">
					<div class="col-xs-12">
						<h2>Crear nuevo <span class="color_wallaviso">Wallaviso</span></h2>
					</div>
				</div>
				<div class="row">
					<div class="col-sm-6 text-right">
						<h3><strong>[[ search ]]</strong></h3>
					</div>
					<div class="col-sm-6">
						<button class="btn btn-success pull-left"  v-on:click="add(search)">
							<i class="fa fa-plus" aria-hidden="true"></i> Crear
						</button>
					</div>
				</div>
				{% if not results %}
				<div class="row">
					<div class="col-xs-12 text-center">
						<h3>No se ha encontrado nada. ¿Lo programas igualmente?</h3>
					</div>
				</div>
				{% endif %}
				{% if results %}
				<div class="row">
					<div class="col-xs-12 text-center">
						<h3>O</h3>
					</div>
				</div>
				<div class="row">
					<div class="col-sm-6 text-right">
						<h3><strong>[[ search_item ]]</strong></h3>
					</div>
					<div class="col-sm-6">
						<button class="btn btn-success pull-left" v-on:click="add(search_item)">
							<i class="fa fa-plus" aria-hidden="true"></i> Crear
						</button>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-12">
						<hr>
						<button class="btn btn-success" v-on:click="back">
							<i class="fa fa-arrow-left" aria-hidden="true"></i> Volver
						</button>
					</div>
				</div>
				{% endif %}
			</section>
			</main>
			{% else %}
				<div class="row" id="not_results">
					<div class="col-xs-12 text-center">
						<i class="fa fa-bell-slash" aria-hidden="true"></i>
						<h3>¿Buscamos algo?</h3>
					</div>
				</div>
			{% endif %}
		</div>
	</div>
</div>
<div id="globals" data-urlapipostalcode="{{ URL_API_POSTAL_CODE }}"></div>
{% if request.method == 'POST' %}
<script>
(function() {
        // Scroll animation
	if(window.innerWidth < 768) window.scrollTo(0, document.querySelector('#separation').scrollHeight);
})();
</script>
{% endif %}
<script>
(function() {
    // Statics
    var URL_API_POSTAL_CODE = ''
})();
</script>
{% endblock %}
